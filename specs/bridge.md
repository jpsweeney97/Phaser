# Specification: Audit Bridge

**Module:** `tools/bridge.py`  
**Version:** 1.7.0  
**Lines:** 1463  
**Status:** Stable

---

## 1. Purpose

The Audit Bridge parses, validates, splits, and executes audit documents generated by Claude.ai. It serves as the integration layer between human-authored audit specifications and Claude Code execution.

---

## 2. Core Concepts

### 2.1 Setup Block

A delimited text blob containing all audit files for Claude Code ingestion.

```
=== AUDIT SETUP START ===
[Prerequisites section]
[Document content]
[Phase definitions]
=== AUDIT SETUP END ===
```

**Markers:**
- `SETUP_START_MARKER`: `"=== AUDIT SETUP START ==="`
- `SETUP_END_MARKER`: `"=== AUDIT SETUP END ==="`

### 2.2 Document Structure

```
# Document N: Title

## Document Overview
[High-level description]

## Prerequisites
- Python version: ...
- Dependencies: ...
- **Baseline tests:** N passing

## Phase M: Phase Title

### Context
[Why this phase exists]

### Goal
[What we're achieving]

### Files
| File | Action | Purpose |
|------|--------|---------|
| path/to/file.py | CREATE | Description |

### Plan
1. Step one
2. Step two

### Implementation
[Code blocks and instructions]

### Verify
```bash
pytest tests/test_feature.py -v
# Expected: N passed
```

### Acceptance Criteria
- [ ] Criterion one
- [ ] Criterion two

### Rollback
[Recovery steps if phase fails]

### Completion
[Post-phase checklist updates]

## Document Completion
[Summary and next steps]
```

### 2.3 Phase Numbering

Phases are numbered globally across all documents in an audit. A single document may contain phases 36-42, continuing from a previous document that ended at phase 35.

---

## 3. Data Structures

### 3.1 AuditDocument

```python
@dataclass
class AuditDocument:
    title: str                    # "Document 7: Reverse Audit"
    document_number: int          # 7
    source_path: Path | None      # Original file location
    overview: str | None          # Document Overview section
    prerequisites: str | None     # Prerequisites section
    phases: list[Phase]           # Parsed phases
    setup_block: str              # Extracted setup block
    completion_block: str | None  # Document Completion section
    raw_content: str              # Original markdown
```

**Computed Properties:**
- `phase_count`: Number of phases
- `phase_start`: First phase number
- `phase_end`: Last phase number
- `phase_range`: String like "36-42"

### 3.2 Phase

```python
@dataclass
class Phase:
    number: int                        # 36
    title: str                         # "Reverse Audit Specification"
    context: str                       # ### Context content
    goal: str                          # ### Goal content
    files: list[PhaseFile]             # Parsed Files table
    plan: list[str]                    # ### Plan items
    implementation: str                # ### Implementation content
    verify: str                        # ### Verify content
    acceptance_criteria: list[str]     # ### Acceptance Criteria items
    rollback: str                      # ### Rollback content
    completion: str                    # ### Completion content
    raw_content: str                   # Full phase markdown
    line_start: int                    # Line number in source
```

**Computed Properties:**
- `estimated_tokens`: `len(raw_content) / 3.5` (conservative estimate)

### 3.3 PhaseFile

```python
@dataclass
class PhaseFile:
    path: str           # "tools/reverse.py"
    action: FileAction  # CREATE, MODIFY, DELETE
    purpose: str        # "Reverse audit module"
```

### 3.4 FileAction

```python
class FileAction(str, Enum):
    CREATE = "CREATE"
    MODIFY = "MODIFY"
    DELETE = "DELETE"
```

### 3.5 ValidationResult

```python
@dataclass
class ValidationResult:
    valid: bool                              # True if no errors
    errors: list[ValidationIssue]            # Blocking issues
    warnings: list[ValidationIssue]          # Advisory issues
    source_path: str | None                  # File being validated
    document_title: str | None               # Parsed title
    phase_count: int                         # Number of phases
    phase_range: str | None                  # "36-42"
    token_estimates: dict[str, int]          # Per-phase token counts
```

### 3.6 ValidationIssue

```python
@dataclass
class ValidationIssue:
    level: str        # "error" or "warning"
    phase: int | None # Phase number, or None for document-level
    line: int | None  # Line number, if applicable
    message: str      # Human-readable message
```

---

## 4. Parsing

### 4.1 Header Patterns

```python
DOCUMENT_HEADER_PATTERN = re.compile(r"^# Document (\d+):\s*(.+)$", re.MULTILINE)
PHASE_HEADER_PATTERN = re.compile(r"^## Phase (\d+):\s*(.+)$", re.MULTILINE)
COMPLETION_HEADER_PATTERN = re.compile(r"^## Document Completion", re.MULTILINE)
```

### 4.2 Code Block Handling

Phase boundaries inside code blocks are ignored. The parser uses CommonMark-compliant fence detection:

- Opening fence: 3+ backticks (```) or tildes (~~~)
- Closing fence: Same character, >= length of opening
- Nested fences with different characters are handled correctly

```python
def find_code_block_ranges(content: str) -> list[tuple[int, int]]
def is_inside_code_block(pos: int, ranges: list[tuple[int, int]]) -> bool
def detect_phase_boundaries(content: str) -> list[tuple[int, int, int]]
```

### 4.3 Section Extraction

Each phase section is extracted by matching `### SectionName` headers:

```python
def extract_section(content: str, header: str) -> str | None
```

Sections: Context, Goal, Files, Plan, Implementation, Verify, Acceptance Criteria, Rollback, Completion

### 4.4 Files Table Parsing

The Files table uses markdown table format:

```markdown
### Files
| File | Action | Purpose |
|------|--------|---------|
| tools/new.py | CREATE | New module |
| tools/old.py | MODIFY | Add feature |
```

```python
def parse_files_table(content: str) -> list[PhaseFile]
```

---

## 5. Validation

### 5.1 Document-Level Checks

| Check | Level | Message |
|-------|-------|---------|
| Missing `# Document N:` header | warning | "Missing document header" |
| Missing `## Document Overview` | warning | "Missing Document Overview section" |
| Missing `## Prerequisites` | warning | "Missing Prerequisites section" |
| Unparseable baseline test count | warning | "Could not parse baseline test count" |

### 5.2 Phase-Level Checks

**Required Sections (error if missing):**
- Context
- Goal
- Implementation
- Verify
- Completion

**Recommended Sections (warning if missing):**
- Plan
- Acceptance Criteria
- Rollback

### 5.3 Token Limits

| Threshold | Level | Action |
|-----------|-------|--------|
| >= 25,000 tokens | error | "Must split phase" |
| >= 20,000 tokens | warning | "Consider splitting" |

```python
TOKEN_WARNING_THRESHOLD = 20000
TOKEN_ERROR_THRESHOLD = 25000
```

### 5.4 Code Block Validation

- Warning for code blocks missing language identifier

### 5.5 Verify Section Validation

- Warning if Verify section lacks `# Expected:` comments

---

## 6. File Generation

### 6.1 Directory Structure

```
project/
├── .audit/
│   └── phases/
│       ├── setup.md
│       ├── phase-36.md
│       ├── phase-37.md
│       └── ...
└── .audit-meta/
    ├── phaser-version
    ├── baseline-tests
    └── base-commit
```

### 6.2 setup.md Content

Combines Prerequisites section with setup block:

```python
def create_setup_file_content(content: str) -> str:
    prereq = extract_prerequisites(content) or ""
    setup_block = extract_setup_block(content)
    return prereq + "\n\n---\n\n" + setup_block
```

### 6.3 Phase File Naming

Zero-padded based on highest phase number:

```python
def calculate_zero_padding(max_phase: int) -> int:
    return len(str(max_phase))

# Examples:
# max_phase=9  → phase-1.md, phase-9.md
# max_phase=42 → phase-36.md, phase-42.md
# max_phase=100 → phase-036.md, phase-100.md
```

### 6.4 Metadata Files

Written to `.audit-meta/`:

| File | Content |
|------|---------|
| `phaser-version` | Current Phaser version |
| `baseline-tests` | Parsed from Prerequisites |
| `base-commit` | Written during setup.md execution |

---

## 7. Execution

### 7.1 Prompt Generation

The bridge generates an execution prompt for Claude Code:

```
Execute audit-phases/setup.md first, then execute 
audit-phases/phase-36.md through phase-42.md in order.

IMPORTANT: During setup.md execution, after creating 
the git branch, run:
  mkdir -p .audit-meta
  git rev-parse HEAD > .audit-meta/base-commit

For each phase:
1. Read the phase file completely before starting
2. Execute all steps in the Implementation section
3. Run all Verify commands and confirm expected output
4. If verification fails, debug and fix
5. Execute the Completion section
6. Proceed immediately to the next phase
```

### 7.2 Execution Report

After all phases, generates `EXECUTION_REPORT.md` with:

- Audit metadata (date, commit range, Phaser version)
- Per-phase execution summary
- Test count changes (baseline → final)
- File change summary

---

## 8. Error Handling

### 8.1 Exception Hierarchy

```python
class BridgeError(Exception):
    """Base error for bridge operations."""

class ParseError(BridgeError):
    """Error parsing audit document."""
    def __init__(self, message: str, line: int | None = None)

class ValidationError(BridgeError):
    """Error validating audit document structure."""
    def __init__(self, message: str, issues: list[ValidationIssue] | None = None)

class ExecutionError(BridgeError):
    """Error executing audit."""
```

### 8.2 Error Codes

| Scenario | Exit Code |
|----------|-----------|
| Success | 0 |
| Validation errors | 1 |
| Parse error | 1 |
| File not found | 1 |

---

## 9. Public API

### 9.1 Parsing

```python
def parse_document(content: str, source_path: Path | None = None) -> AuditDocument
```

### 9.2 Validation

```python
def validate_document(content: str, source_path: Path | None = None) -> ValidationResult
```

### 9.3 Preparation

```python
def prepare_audit(
    audit_path: Path,
    project_dir: Path | None = None,
    copy_audit: bool = True,
) -> PrepareResult
```

**Parameters:**
- `audit_path`: Path to audit document
- `project_dir`: Target project (default: current directory)
- `copy_audit`: Whether to copy audit file to project

**Returns:** `PrepareResult` with document, validation, paths, and prompt

### 9.4 Extraction

```python
def extract_setup_block(content: str) -> str
def extract_prerequisites(content: str) -> str | None
def parse_baseline_test_count(prerequisites: str) -> int
```

---

## 10. CLI Integration

The bridge integrates with CLI via these commands:

| Command | Function |
|---------|----------|
| `phaser validate <file>` | Validate without execution |
| `phaser prepare <file>` | Split into phases, generate prompt |
| `phaser execute <file>` | Prepare + launch Claude Code |

See `specs/cli.md` for full command documentation.

---

## 11. Constants

```python
PHASER_VERSION = "1.7.0"
SETUP_START_MARKER = "=== AUDIT SETUP START ==="
SETUP_END_MARKER = "=== AUDIT SETUP END ==="
TOKEN_WARNING_THRESHOLD = 20000
TOKEN_ERROR_THRESHOLD = 25000
```

---

## 12. Dependencies

- `re` (stdlib): Pattern matching
- `shutil` (stdlib): File operations
- `subprocess` (stdlib): Claude Code launch
- `dataclasses` (stdlib): Data structures
- `pathlib` (stdlib): Path handling

No external dependencies.

---

*Specification for tools/bridge.py — Phaser v1.7.0*
