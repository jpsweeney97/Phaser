# CI Check Specification

> Phaser v1.3 — CI Integration Feature

---

## Overview

CI Check generates workflow files that run Phaser contract checks automatically on code changes. This ensures audit-extracted rules are continuously enforced without manual intervention.

---

## Purpose

1. **Automate enforcement** — Run contract checks on every push/PR
2. **Block regressions** — Fail CI if contracts are violated
3. **Zero configuration** — Generate working workflow with sensible defaults
4. **Extensible** — Support multiple CI platforms (GitHub Actions first)

---

## Supported Platforms

| Platform | Status | Workflow File |
|----------|--------|---------------|
| GitHub Actions | Supported | `.github/workflows/phaser.yml` |
| GitLab CI | Planned | `.gitlab-ci.yml` |
| CircleCI | Planned | `.circleci/config.yml` |

---

## CLI Interface

### phaser ci init

Generate CI workflow file for the current project.

```bash
phaser ci init [OPTIONS]

Options:
  --platform TEXT      CI platform (default: github)
  --output PATH        Custom output path (default: platform-specific)
  --python-version TEXT  Python version (default: "3.11")
  --on-push / --no-on-push  Trigger on push (default: True)
  --on-pr / --no-on-pr      Trigger on PR (default: True)
  --branches TEXT      Branches to trigger on (default: main,master)
  --fail-on-warning    Also fail on warning-severity violations
  --force              Overwrite existing workflow file
  --dry-run            Print workflow without writing file
```

**Examples:**

```bash
# Generate default GitHub Actions workflow
phaser ci init

# Generate with custom Python version
phaser ci init --python-version 3.12

# Preview without writing
phaser ci init --dry-run

# Only trigger on PRs to main
phaser ci init --no-on-push --branches main
```

### phaser ci status

Show CI integration status for current project.

```bash
phaser ci status [OPTIONS]

Options:
  --format TEXT   Output format: text, json (default: text)
```

**Output:**

```
CI Integration Status
=====================
Platform: GitHub Actions
Workflow: .github/workflows/phaser.yml
Status: Active
Last generated: 2025-12-05T10:30:00Z

Triggers:
  - push to: main, master
  - pull_request to: main, master

Contracts: 5 enabled
  - no-singleton-pattern (error)
  - require-observable (warning)
  - license-required (error)
  - no-env-file (error)
  - readme-has-installation (warning)
```

### phaser ci remove

Remove CI workflow file.

```bash
phaser ci remove [OPTIONS]

Options:
  --platform TEXT   CI platform (default: github)
  --force           Remove without confirmation
```

---

## Workflow Template

### GitHub Actions

The generated workflow installs Phaser and runs contract checks.

```yaml
# Generated by Phaser v1.3
# https://github.com/anthropics/phaser

name: Phaser Contract Check

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  phaser-check:
    name: Check Contracts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Phaser
        run: |
          pip install phaser

      - name: Run contract checks
        run: |
          phaser check --fail-on-error --format text

      - name: Upload results (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: phaser-results
          path: .phaser/check-results.json
          retention-days: 7
```

---

## Configuration

### Workflow Metadata

Stored in `.phaser/ci.yaml`:

```yaml
version: 1
platform: github
workflow_path: .github/workflows/phaser.yml
generated_at: "2025-12-05T10:30:00Z"
phaser_version: "1.3.0"

options:
  python_version: "3.11"
  on_push: true
  on_pr: true
  branches:
    - main
    - master
  fail_on_warning: false
```

### Custom Workflow Path

Users can specify custom output paths:

```bash
# Custom path
phaser ci init --output .github/workflows/contracts.yml
```

---

## Data Classes

### CIPlatform (Enum)

```python
class CIPlatform(str, Enum):
    GITHUB = "github"
    GITLAB = "gitlab"
    CIRCLECI = "circleci"
```

### CIConfig

```python
@dataclass
class CIConfig:
    platform: CIPlatform
    workflow_path: Path
    generated_at: str
    phaser_version: str
    python_version: str
    on_push: bool
    on_pr: bool
    branches: list[str]
    fail_on_warning: bool

    def to_dict(self) -> dict[str, Any]: ...
    @classmethod
    def from_dict(cls, d: dict) -> "CIConfig": ...
```

### CIStatus

```python
@dataclass
class CIStatus:
    platform: CIPlatform
    workflow_exists: bool
    workflow_path: Path | None
    config: CIConfig | None
    contract_count: int
    error_count: int
    warning_count: int

    def to_dict(self) -> dict[str, Any]: ...
```

---

## Core Functions

### generate_workflow

```python
def generate_workflow(
    platform: CIPlatform,
    config: CIConfig,
) -> str:
    """
    Generate workflow file content for the specified platform.

    Args:
        platform: Target CI platform
        config: Workflow configuration

    Returns:
        Workflow file content as string

    Raises:
        ValueError: If platform is not supported
    """
```

### init_ci

```python
def init_ci(
    storage: PhaserStorage,
    platform: CIPlatform = CIPlatform.GITHUB,
    python_version: str = "3.11",
    on_push: bool = True,
    on_pr: bool = True,
    branches: list[str] | None = None,
    fail_on_warning: bool = False,
    output_path: Path | None = None,
    force: bool = False,
) -> tuple[Path, CIConfig]:
    """
    Initialize CI integration for the project.

    Args:
        storage: PhaserStorage instance
        platform: Target CI platform
        python_version: Python version for workflow
        on_push: Trigger on push events
        on_pr: Trigger on pull request events
        branches: Branches to trigger on (default: main, master)
        fail_on_warning: Fail on warning-severity violations
        output_path: Custom workflow output path
        force: Overwrite existing workflow

    Returns:
        Tuple of (workflow_path, config)

    Raises:
        FileExistsError: If workflow exists and force=False
    """
```

### get_ci_status

```python
def get_ci_status(
    storage: PhaserStorage,
    root: Path,
) -> CIStatus:
    """
    Get CI integration status for the project.

    Args:
        storage: PhaserStorage instance
        root: Project root directory

    Returns:
        CIStatus with current state
    """
```

### remove_ci

```python
def remove_ci(
    storage: PhaserStorage,
    platform: CIPlatform = CIPlatform.GITHUB,
) -> bool:
    """
    Remove CI workflow file.

    Args:
        storage: PhaserStorage instance
        platform: Target CI platform

    Returns:
        True if removed, False if not found
    """
```

---

## Template System

Templates are stored in `tools/templates/ci/` as Jinja2-compatible strings:

```
tools/
└── templates/
    └── ci/
        ├── github.yml.template
        ├── gitlab.yml.template
        └── circleci.yml.template
```

Template variables:

| Variable | Description | Example |
|----------|-------------|---------|
| `{{ python_version }}` | Python version | "3.11" |
| `{{ branches }}` | Branch list | ["main", "master"] |
| `{{ on_push }}` | Push trigger enabled | true |
| `{{ on_pr }}` | PR trigger enabled | true |
| `{{ fail_on_warning }}` | Fail on warnings | false |
| `{{ phaser_version }}` | Phaser version | "1.3.0" |
| `{{ generated_at }}` | Generation timestamp | "2025-12-05T10:30:00Z" |

---

## Integration with Contracts

CI Check automatically detects enabled contracts:

```python
# In workflow generation
contracts = load_contracts(storage, enabled_only=True)
error_contracts = [c for c in contracts if c.rule.severity == Severity.ERROR]
warning_contracts = [c for c in contracts if c.rule.severity == Severity.WARNING]

# Warn if no contracts
if not contracts:
    click.echo("Warning: No contracts found. CI check will always pass.")
```

---

## Error Handling

| Scenario | Behavior |
|----------|----------|
| No contracts exist | Warn user, generate workflow anyway |
| Workflow already exists | Error unless --force |
| Unsupported platform | Error with supported platforms list |
| Invalid Python version | Error with valid versions |
| No write permission | Error with path |

---

## Exit Codes

For `phaser ci init`:

| Code | Meaning |
|------|---------|
| 0 | Workflow generated successfully |
| 1 | Workflow exists (use --force) |
| 2 | Invalid configuration |

For `phaser ci status`:

| Code | Meaning |
|------|---------|
| 0 | CI is configured |
| 1 | CI is not configured |

---

## Example Usage

### Basic Setup

```bash
# Initialize CI
phaser ci init
# Output: Created .github/workflows/phaser.yml

# Check status
phaser ci status
# Output: CI Integration Status...

# Remove if needed
phaser ci remove --force
```

### Custom Configuration

```bash
# Python 3.12, only PRs, only main branch
phaser ci init \
  --python-version 3.12 \
  --no-on-push \
  --branches main \
  --fail-on-warning
```

### Preview Mode

```bash
# See what would be generated
phaser ci init --dry-run
```

---

*Phaser v1.3 — CI Check Specification*
